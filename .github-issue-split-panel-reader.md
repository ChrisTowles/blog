# Feature: Split-Panel Reader with Contextual Chat

## Overview

Combine the markdown content reader and RAG chat agent into a synchronized split-panel interface where the chat can reference and highlight specific passages in the content.

This creates an interactive reading experience where Claude can cite exact passages, scroll to relevant sections, and highlight specific text while discussing blog posts with users.

## Core Requirements

### 1. Layout Components
- **ContentPanel** - Renders markdown with addressable sections/quotes
- **ChatPanel** - Existing chat agent with enhanced response metadata
- **SplitPanelContainer** - Orchestrates layout and inter-component communication

### 2. User Preferences
- Panel position preference (content-left/chat-right or inverse)
- Panel width ratio
- Persist to localStorage/cookies
- Collapse behavior

### 3. Cross-Panel Communication

When the chat references a quote:

```
User: "What did you say about caching strategies?"
Agent: "In the section on performance, you wrote: '...quote...' [ref:section-id]"
```

The content panel should:
- Scroll to that section
- Highlight the specific passage
- Animate to draw attention

## Recommended Architecture

### Route Structure
- **New route:** `/reader/[slug]` with dedicated layout
- Keeps chat-only mode clean (`/chat/:id` unchanged)
- SEO-friendly URLs for shared reader sessions

### Reference System
**Custom Tool:** `searchBlogContentWithReferences`
```typescript
{
  results: [...],
  references: [
    {
      id: "ref-1",
      documentUrl: "/blog/tips-for-claude-code",
      documentSlug: "tips-for-claude-code",
      chunkIndex: 0,
      heading: "Introduction",
      snippet: "Claude Code is...",
      highlightText: "specific phrase to highlight"
    }
  ]
}
```

**Custom Component:** `BlogReference.vue` for interactive citations

### Highlighting Strategy
- **Primary:** CSS text fragments (`#:~:text=...`) for modern browsers
- **Fallback:** Dynamic `<mark>` injection with animation
- **Animation:** Pulse on appear, gradient fade over 10s
- **Multiple:** Support up to 3 simultaneous highlights

### State Management
**New Composable:** `useReaderSync.ts`
```typescript
interface ReaderState {
  documentSlug: string
  chatId: string | null
  activeHighlight: HighlightState | null
  scrollTarget: ContentAddress | null
  panelLayout: 'horizontal' | 'vertical'
  contentPanelSize: number
}
```

### Mobile Strategy
- **Desktop (≥768px):** Side-by-side resizable panels (60/40 default)
- **Mobile (<768px):** Full-screen content + floating chat button → modal overlay

## Implementation Phases

### Phase 1: Foundation & Content Panel
**Goal:** Basic split-panel layout with content viewer

**Tasks:**
- [ ] Create route `/reader/[slug].vue`
- [ ] Create `ReaderContainer.vue` with `UDashboardGroup`
- [ ] Create `ReaderPanel.vue` with `ContentRenderer`
- [ ] Create `useReaderPreferences.ts` for panel settings
- [ ] Implement responsive layout (desktop/mobile)

**Files:**
- `app/pages/reader/[slug].vue`
- `app/components/reader/ReaderContainer.vue`
- `app/components/reader/ReaderPanel.vue`
- `app/composables/useReaderPreferences.ts`

### Phase 2: Chat Panel Integration
**Goal:** Embed chat in right panel, link to document context

**Tasks:**
- [ ] Create `ReaderChat.vue` with `useChat` composable
- [ ] Add document context to chat system prompt
- [ ] Link chat session to document (URL query param)
- [ ] Add "Chat about this post" button to blog pages
- [ ] Persist chat-document associations

**Files:**
- `app/components/reader/ReaderChat.vue`
- `app/pages/blog/[slug].vue` (modify)

### Phase 3: Reference Tool & Highlighting ⭐
**Goal:** Agent can reference passages and trigger highlights

**Tasks:**
- [ ] Extend RAG tool: `searchBlogContentWithReferences`
- [ ] Extract heading from chunk content (parse markdown)
- [ ] Create `BlogReference.vue` tool component
- [ ] Update chat system prompt for reference usage
- [ ] Implement `useReaderSync.ts` composable
- [ ] Create `ContentHighlight.vue` with animations

**Files:**
- `server/utils/ai/tools.ts` (extend)
- `app/components/tool/BlogReference.vue`
- `app/components/reader/ContentHighlight.vue`
- `app/composables/useReaderSync.ts`

### Phase 4: Enhanced Addressing & UX Polish
**Goal:** Robust content addressing, smooth animations, mobile UX

**Tasks:**
- [ ] Implement fuzzy text matching (Levenshtein distance)
- [ ] Add heading extraction to RAG results
- [ ] Smooth scroll behavior with `scrollIntoView`
- [ ] Polished highlight animations (pulse, gradient fade)
- [ ] Mobile modal chat with FAB button
- [ ] Keyboard shortcuts (Cmd+K, Cmd+/, Escape)

### Phase 5: Advanced Features
**Goal:** Multi-document support, performance, analytics

**Tasks:**
- [ ] Multi-document references (cross-post linking)
- [ ] Reference preview on hover
- [ ] Citation export (copy as markdown)
- [ ] Performance optimization (lazy-load, debounce)
- [ ] Analytics tracking
- [ ] SEO & sharing meta tags

## Key Technical Advantages

✅ **RAG already returns full metadata** - No backend changes needed for basic references
✅ **Resizable panel support** - `UDashboardSidebar` pattern exists
✅ **Custom tool components** - Pattern established (`ToolWeather.vue`, `ToolDice.vue`)
✅ **Composables pattern** - No Pinia needed, follows existing architecture
✅ **Content anchors built-in** - Nuxt Content auto-generates heading IDs

## Critical Files

1. `server/utils/ai/tools.ts` - Extend with reference tool
2. `app/composables/useReaderSync.ts` - Cross-panel state management (NEW)
3. `app/components/reader/ReaderContainer.vue` - Main orchestrator (NEW)
4. `app/components/tool/BlogReference.vue` - Reference UI (NEW)
5. `app/pages/reader/[slug].vue` - Entry point (NEW)

## Open Questions

- [ ] Should we support multi-page references (chat referencing content from different posts)?
- [ ] Tablet behavior: Horizontal or vertical stacking preference?
- [ ] Should reader mode be the default for blog posts (with option to disable)?

## Related

- Current chat implementation: `app/pages/chat/[id].vue`
- RAG retrieval: `server/utils/rag/retrieve.ts`
- Blog content display: `app/pages/blog/[slug].vue`

---

**Labels:** enhancement, feature, chat, ux
**Milestone:** Reader Mode v1
