# Plan: Docker Compose Worktree Support

Enable docker-compose to work with git worktrees via slot-based port/naming isolation.

## Summary

- Remove hardcoded container names from docker-compose
- Use `COMPOSE_PROJECT_NAME` and `DB_PORT` from `.env`
- Main repo requires `.env` with `COMPOSE_PROJECT_NAME=blog`, `DB_PORT=5432`
- Worktrees get their `.env` generated by `worktree.ts` using slots config

---

## Implementation

### Phase 1: Update docker-compose.yml

**File:** `docker-compose.yml`

```yaml
services:
  postgres:
    image: pgvector/pgvector:pg17
    # REMOVE: container_name: blog-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: postgres
    ports:
      - '${DB_PORT:-5432}:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
```

**Changes:**

- [ ] Remove `container_name: blog-postgres`
- [ ] Change port from `"5432:5432"` to `"${DB_PORT:-5432}:5432"`

### Phase 2: Update .env.example

**File:** `.env.example`

Add at top:

```env
# Docker Compose isolation (required for worktree support)
COMPOSE_PROJECT_NAME=blog
DB_PORT=5432
```

Update DATABASE_URL:

```env
DATABASE_URL=postgresql://postgres:postgres@localhost:${DB_PORT:-5432}/postgres
```

**Changes:**

- [ ] Add `COMPOSE_PROJECT_NAME=blog`
- [ ] Add `DB_PORT=5432`
- [ ] Update `DATABASE_URL` to use `${DB_PORT:-5432}`

### Phase 3: Update worktree slots config template

**File:** `scripts/worktree.ts` (cmdInit function default config)

Update the default slots to use `DB_PORT` consistently:

```jsonc
{
  "slots": {
    "slot-1": { "DB_PORT": 5433 },
    "slot-2": { "DB_PORT": 5434 },
    "slot-3": { "DB_PORT": 5435 },
    "slot-4": { "DB_PORT": 5436 },
    "slot-5": { "DB_PORT": 5437 },
  },
}
```

Also add `COMPOSE_PROJECT_NAME` to template or derive from slot name.

**Changes:**

- [ ] Update default slots config in `cmdInit()` to use `DB_PORT` (remove `PORT`)
- [ ] Add `COMPOSE_PROJECT_NAME` as slot variable (e.g., `blog-slot-1`)
- [ ] Update `.env.template` generation to include `COMPOSE_PROJECT_NAME` and `DATABASE_URL`

### Phase 4: Documentation

**File:** `CLAUDE.md` or README

Add worktree setup section:

```markdown
## Worktree Development

Main repo requires `.env` with:

- `COMPOSE_PROJECT_NAME=blog`
- `DB_PORT=5432`

Worktrees get `.env` auto-generated via `nr worktree create <issue>`.
```

**Changes:**

- [ ] Document new `.env` requirements
- [ ] Note that main repo .env is now required (not optional)

---

## TODOs

- [ ] Update `docker-compose.yml` - remove container_name, add DB_PORT interpolation
- [ ] Update `.env.example` - add COMPOSE_PROJECT_NAME, DB_PORT, update DATABASE_URL
- [ ] Update `scripts/worktree.ts` - fix default slots config and .env.template
- [ ] Update documentation in CLAUDE.md
- [ ] Test: main repo with new .env
- [ ] Test: create worktree, verify isolated containers

---

## Edge Cases

1. **Existing containers** - Users with existing `blog-postgres` container need to `docker compose down` before switching
2. **Database data** - Each worktree gets isolated volume (`blog_postgres_data` vs `blog-slot-1_postgres_data`)
3. **Port conflicts** - If DB_PORT isn't set, defaults to 5432 (backwards compat for main)

---

## Rollback

If issues arise:

1. Restore `container_name: blog-postgres` in docker-compose.yml
2. Change port back to `"5432:5432"`
3. Remove new vars from .env.example
